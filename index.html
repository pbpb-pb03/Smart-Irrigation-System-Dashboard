<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Smart Irrigation System Monitoring</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<link rel="icon" href="favicon.png" sizes="32x32">
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
<link rel="stylesheet" href="https://unpkg.com/leaflet-minimap/dist/Control.MiniMap.min.css" />

<style>
body { margin:0; text-align:center; font-family:Arial; }

#header {
  background:#d2ffcf;
  color:darkgreen;
  padding:10px;
  font-weight:bold;
}

#status {
  background:#eef;
  padding:6px;
  font-size:14px;
}

#legend {
  position:absolute;
  left:20px;
  top:100px;
  background:#eef;
  padding:12px;
  border-radius:8px;
  box-shadow:0 3px 8px rgba(0,0,0,0.3);
  font-size:14px;
  text-align:left;
  line-height:1.5;
  z-index:999;
}

#map { height:500px; width:100%; }

.leaflet-div-icon {
  background: none !important;
  border: none !important;
}
</style>
</head>

<body>

<div id="header">
<h2>Smart Irrigation Dashboard</h2>
</div>

<div id="status">
<b>Average Soil:</b> <span id="soil">--</span>% |
<b>Main Water:</b> <span id="water">--</span>%
</div>

<div id="legend">
<b>LEGEND</b><br><br>
ðŸŸ¢ Soil OK â‰¥40%<br>
ðŸ”´ Soil Dry <40%<br><br>
ðŸŸ¢ Trapdoor OPEN<br>
ðŸ”´ Trapdoor CLOSED<br><br>
ðŸ”µ Water Normal â‰¥25%<br>
ðŸŸ  Water Low <25%<br>
ðŸ”´ Overflow â‰¥40%
</div>

<div id="map"></div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet-minimap/dist/Control.MiniMap.min.js"></script>

<script>
const map = L.map('map').setView([9.878639,123.590517], 18);

// Google Satellite Tiles
L.tileLayer('https://{s}.google.com/vt/lyrs=s&x={x}&y={y}&z={z}',{
  maxZoom:25,
  subdomains:['mt0','mt1','mt2','mt3']
}).addTo(map);

// MiniMap
const miniMapLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png');
new L.Control.MiniMap(miniMapLayer,{toggleDisplay:true}).addTo(map);

// Clean dot markers
function makeDot(color){
  return L.divIcon({
    html:`<div style="width:12px;height:12px;border-radius:50%;
    background:${color};"></div>`,
    className: ''
  });
}

// MARKERS
const soilMarkers = [
  L.marker([9.878869,123.590627]),
  L.marker([9.878761,123.590973]),
  L.marker([9.878670,123.591522]),
  L.marker([9.878307,123.591236])
];

const trapdoorMarkers = [
  L.marker([9.880028,123.591534]),
  L.marker([9.879988,123.591630]),
  L.marker([9.878530,123.590804]),
  L.marker([9.878422,123.591424])
];

const mainWaterMarker = L.marker([9.879963,123.591384]);
const downstreamWaterMarker = L.marker([9.878364,123.590804]);

[...soilMarkers,...trapdoorMarkers,mainWaterMarker,downstreamWaterMarker]
.forEach(m => m.addTo(map));
</script>

<script type="module">
import {initializeApp} from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
import {getDatabase,ref,onValue} from "https://www.gstatic.com/firebasejs/12.6.0/firebase-database.js";

const firebaseConfig = {
  apiKey:"AIzaSyC_2_mTMBezUGrXb74aBtl_0FzcqmL1tW8",
  databaseURL:"https://agos-d6a27-default-rtdb.asia-southeast1.firebasedatabase.app"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);
const systemRef = ref(db,"systems/system1");

onValue(systemRef,(snapshot)=>{
  const data = snapshot.val();
  if(!data) return;

  // STATUS BAR
  const avg = (data.soil.zone1 + data.soil.zone2 + data.soil.zone3 + data.soil.zone4) / 4;
  document.getElementById("soil").textContent = avg.toFixed(1);
  document.getElementById("water").textContent = data.water.main;

  // SOIL MARKERS
  for(let i=0;i<4;i++){
    let v = data.soil["zone"+(i+1)];
    soilMarkers[i].setIcon(makeDot(v<40?"red":"green"));
    soilMarkers[i].bindPopup(`Zone ${i+1}<br>Soil Moisture: ${v}%`);
  }

  // TRAPDOOR LABELS
  const labels = [
    "Trapdoor 1 (Main Gate)",
    "Trapdoor 2 (Zone 3 Gate)",
    "Trapdoor 3 (Exit Gate)",
    "Trapdoor 4 (Zone 4 Gate)"
  ];

  for(let i=0;i<4;i++){
    let s = data.trapdoors["zone"+(i+1)];
    trapdoorMarkers[i].setIcon(makeDot(s==="OPEN"?"green":"red"));
    trapdoorMarkers[i].bindPopup(`${labels[i]}<br>Status: ${s}`);
  }

  // WATER MARKERS
  mainWaterMarker.setIcon(makeDot(
    data.water.main>=40?"red": data.water.main<25?"orange":"blue"
  ));
  mainWaterMarker.bindPopup(`Main Water<br>${data.water.main}%`);

  downstreamWaterMarker.setIcon(makeDot(
    data.water.downstream>=40?"red": data.water.downstream<25?"orange":"blue"
  ));
  downstreamWaterMarker.bindPopup(`Downstream Water<br>${data.water.downstream}%`);
});
</script>

</body>
</html>
