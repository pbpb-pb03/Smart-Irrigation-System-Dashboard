<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>ESP32 Irrigation Monitoring</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- FAVICON -->
  <link rel="icon" type="image/png" href="favicon.png">

  <!-- Leaflet CSS -->
  <link rel="stylesheet"
        href="https://unpkg.com/leaflet/dist/leaflet.css"/>

  <style>
    body {
      margin: 0;
      font-family: Arial, sans-serif;
      text-align: center;
    }

    #header {
      background: #568138;
      color: white;
      padding: 10px;
    }

    #header img {
      height: 55px;
      vertical-align: middle;
      margin-right: 10px;
    }

    #status {
      background: #eef;
      padding: 6px;
      font-size: 14px;
    }

    /* LEGEND STYLE â€” LEFT & FIT CONTENT */
    #legend {
      position: absolute;
      left: 10px;
      top: 120px;
      background: #eef;
      padding: 12px;
      font-size: 14px;
      text-align: left;
      border-radius: 8px;
      box-shadow: 0 3px 8px rgba(0,0,0,0.3);
      width: fit-content;
      z-index: 999;
    }

    #map {
      height: 600px;
      width: 100%;
    }
  </style>
</head>

<body>

<div id="header">
  <img src="logo.png">
  <h2 style="display:inline;">Smart Irrigation Dashboard</h2>
</div>

<div id="status">
  <b>Average Soil Moisture:</b> <span id="soil">--</span>% |
  <b>Main Water Level:</b> <span id="water">--</span>%
</div>

<div id="legend">
  <b>LEGEND</b><br><br>

  ðŸŸ¢ Soil OK (â‰¥40%)<br>
  ðŸ”´ Soil Dry (<40%)<br><br>

  ðŸŸ¢ Trapdoor OPEN<br>
  ðŸ”´ Trapdoor CLOSED<br><br>

  ðŸ”µ Water Sufficient (â‰¥30%)<br>
  ðŸŸ  Water Low (<30%)
</div>

<div id="map"></div>

<!-- Leaflet JS -->
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<script>
  const map = L.map('map').setView([9.878639, 123.590517], 18);

  L.tileLayer(
    'https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}',
    { maxZoom: 22 }
  ).addTo(map);

  /* ICONS */
  const soilIcon = L.icon({
    iconUrl: "soil.png",
    iconSize: [32, 32],
    iconAnchor: [16, 32]
  });

  const waterIcon = L.icon({
    iconUrl: "water.png",
    iconSize: [32, 32],
    iconAnchor: [16, 32]
  });

  const trapdoorIcon = L.icon({
    iconUrl: "trapdoor.png",
    iconSize: [32, 32],
    iconAnchor: [16, 32]
  });

  /* MARKERS */
  const soilMarkers = [
    L.marker([9.878807, 123.590615], {icon: soilIcon}),
    L.marker([9.878693, 123.590954], {icon: soilIcon}),
    L.marker([9.878600, 123.591498], {icon: soilIcon}),
    L.marker([9.878262, 123.591218], {icon: soilIcon})
  ];

  const trapdoorMarkers = [
    L.marker([9.879941, 123.591530], {icon: trapdoorIcon}),
    L.marker([9.879918, 123.591633], {icon: trapdoorIcon}),
    L.marker([9.878463, 123.590804], {icon: trapdoorIcon}),
    L.marker([9.878320, 123.591422], {icon: trapdoorIcon})
  ];

  const mainWaterMarker =
    L.marker([9.879899, 123.591386], {icon: waterIcon});

  const downstreamWaterMarker =
    L.marker([9.878228, 123.590805], {icon: waterIcon});

  [...soilMarkers, ...trapdoorMarkers,
   mainWaterMarker, downstreamWaterMarker]
   .forEach(m => m.addTo(map));

  /* COLOR OVERLAY FUNCTION */
  function colorOverlay(color) {
    return `
      filter: drop-shadow(0 0 6px ${color})
              saturate(200%);
    `;
  }
</script>

<!-- Firebase -->
<script type="module">
import { initializeApp } from
  "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
import { getDatabase, ref, onValue } from
  "https://www.gstatic.com/firebasejs/12.6.0/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyC_2_mTMBezUGrXb74aBtl_0FzcqmL1tW8",
  databaseURL:
    "https://agos-d6a27-default-rtdb.asia-southeast1.firebasedatabase.app"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);
const systemRef = ref(db, "systems/system1");

onValue(systemRef, (snapshot) => {
  const data = snapshot.val();
  if (!data) return;

  const avgSoil =
    (data.soil.zone1 +
     data.soil.zone2 +
     data.soil.zone3 +
     data.soil.zone4) / 4;

  document.getElementById("soil").textContent =
    avgSoil.toFixed(1);

  document.getElementById("water").textContent =
    data.water.main;

  /* SOIL COLORS */
  for (let i = 0; i < 4; i++) {
    const v = data.soil["zone" + (i + 1)];
    const color = v < 40 ? "red" : "green";
    soilMarkers[i].getElement().style =
      `filter: drop-shadow(0 0 6px ${color});`;
    soilMarkers[i].bindPopup(`Soil Zone ${i+1}: ${v}%`);
  }

  /* TRAPDOOR COLORS */
  for (let i = 0; i < 4; i++) {
    const s = data.trapdoors["zone" + (i + 1)];
    const color = s === "OPEN" ? "green" : "red";
    trapdoorMarkers[i].getElement().style =
      `filter: drop-shadow(0 0 6px ${color});`;
    trapdoorMarkers[i].bindPopup(`Trapdoor ${i+1}: ${s}`);
  }

  /* WATER COLORS */
  const mainColor = data.water.main < 30 ? "orange" : "blue";
  mainWaterMarker.getElement().style =
    `filter: drop-shadow(0 0 6px ${mainColor});`;

  const downColor = data.water.downstream < 30 ? "orange" : "blue";
  downstreamWaterMarker.getElement().style =
    `filter: drop-shadow(0 0 6px ${downColor});`;
});
</script>

</body>
</html>

